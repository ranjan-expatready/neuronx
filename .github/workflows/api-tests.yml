name: API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: neuronx_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup environment
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/neuronx_test" >> .env.test
          echo "REDIS_URL=redis://localhost:6379" >> .env.test

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neuronx_test

      - name: Seed test data
        run: npm run db:seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neuronx_test

      - name: Start application
        run: npm run start:test &
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/neuronx_test
          REDIS_URL: redis://localhost:6379

      - name: Wait for application to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'

      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman Collection
        run: |
          newman run postman/NeuronX_API_Collection.postman_collection.json \
            --environment postman/NeuronX_Dev_Environment.postman_environment.json \
            --reporters cli,json \
            --reporter-json-export api-test-results.json \
            --timeout 30000 \
            --delay-request 1000

      - name: Generate API Test Evidence
        run: |
          mkdir -p docs/EVIDENCE/api-tests
          cp api-test-results.json docs/EVIDENCE/api-tests/$(date +%Y%m%d_%H%M%S)_api_test_results.json

          # Generate summary report
          node -e "
            const results = require('./api-test-results.json');
            const summary = {
              timestamp: new Date().toISOString(),
              collection: results.collection.name,
              environment: results.environment.name,
              execution: {
                totalRequests: results.run.stats.requests.total,
                failedRequests: results.run.stats.requests.failed,
                totalAssertions: results.run.stats.assertions.total,
                failedAssertions: results.run.stats.assertions.failed,
                responseTime: {
                  average: Math.round(results.run.timings.responseAverage),
                  min: results.run.timings.responseMin,
                  max: results.run.timings.responseMax
                }
              },
              results: results.run.executions.map(exec => ({
                request: exec.item.name,
                responseTime: exec.response.responseTime,
                status: exec.response.status,
                testsPassed: exec.assertions.filter(a => a.error === undefined).length,
                testsFailed: exec.assertions.filter(a => a.error !== undefined).length
              }))
            };
            console.log(JSON.stringify(summary, null, 2));
          " > docs/EVIDENCE/api-tests/$(date +%Y%m%d_%H%M%S)_api_test_summary.json

      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: |
            api-test-results.json
            docs/EVIDENCE/api-tests/

      - name: Fail on API test failures
        run: |
          FAILED_REQUESTS=$(jq '.run.stats.requests.failed' api-test-results.json)
          FAILED_ASSERTIONS=$(jq '.run.stats.assertions.failed' api-test-results.json)

          if [ "$FAILED_REQUESTS" -gt 0 ] || [ "$FAILED_ASSERTIONS" -gt 0 ]; then
            echo "API tests failed: $FAILED_REQUESTS failed requests, $FAILED_ASSERTIONS failed assertions"
            exit 1
          fi
