name: Redis Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/core-api/src/rate-limit/**'
      - 'apps/core-api/src/rate-limit/__tests__/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/core-api/src/rate-limit/**'
      - 'apps/core-api/src/rate-limit/__tests__/**'

jobs:
  redis-tests:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd apps/core-api
          npm install

      - name: Wait for Redis
        run: |
          until redis-cli -h localhost -p 6379 ping | grep -q PONG; do
            echo "Waiting for Redis..."
            sleep 2
          done
          echo "Redis is ready"

      - name: Run Redis integration tests
        run: |
          cd apps/core-api
          REDIS_URL=redis://localhost:6379 npm test -- rate-limit.redis.store.spec.ts rate-limit.store.integration.spec.ts
        env:
          REDIS_URL: redis://localhost:6379
