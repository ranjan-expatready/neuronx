name: daily-brief

# Daily Brief + Approvals Queue Generator ‚Äî Antigravity Board Member Loop
# This workflow generates daily operational artifacts for Founder review.
# Runs daily at 09:00 UTC and on manual dispatch.

permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not create PR)'
        required: false
        type: boolean
        default: false
  schedule:
    # Run daily at 09:00 UTC
    - cron: '0 9 * * *'

jobs:
  generate_daily_brief:
    name: Generate Daily Brief + Approvals Queue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.DAILY_BRIEF_TOKEN || github.token }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Daily Brief
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.DAILY_BRIEF_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_PROJECT_NUMBER: '2'  # SDLC Project number
        run: |
          echo "ü§ñ Generating Daily Brief + Approvals Queue"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Dry run: ${{ github.event.inputs.dry_run || false }}"
          echo ""

          # Generate artifacts
          output=$(python scripts/generate_daily_brief.py)
          brief_path=$(echo "$output" | grep "brief_file=" | cut -d'=' -f2)
          approvals_path=$(echo "$output" | grep "approvals_file=" | cut -d'=' -f2)

          echo "Brief path: $brief_path"
          echo "Approvals path: $approvals_path"

          # Set outputs
          echo "brief_path=$brief_path" >> $GITHUB_OUTPUT
          echo "approvals_path=$approvals_path" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-brief-artifacts
          path: |
            ${{ steps.generate.outputs.brief_path }}
            ${{ steps.generate.outputs.approvals_path }}
          retention-days: 30

      - name: Create or Update PR
        if: github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const briefPath = '${{ steps.generate.outputs.brief_path }}';
            const approvalsPath = '${{ steps.generate.outputs.approvals_path }}';

            console.log('Brief path:', briefPath);
            console.log('Approvals path:', approvalsPath);

            // Read generated artifacts
            const briefContent = fs.readFileSync(briefPath, 'utf8');
            const approvalsContent = fs.readFileSync(approvalsPath, 'utf8');

            // Get date string for branch naming
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, '');

            // Check out or create daily-brief branch
            const branchName = `daily-brief/${dateStr}`;

            try {
              // Try to fetch existing branch
              execSync(`git fetch origin ${branchName} || true`);
            } catch (e) {
              console.log('Branch does not exist yet');
            }

            // Create branch (or reset it if exists)
            try {
              execSync(`git checkout -B ${branchName}`);
            } catch (e) {
              // Branch might already exist locally
              execSync(`git checkout ${branchName}`);
            }

            // Ensure artifact directories exist
            const briefDir = 'COCKPIT/artifacts/DAILY_BRIEF';
            const approvalsDir = 'COCKPIT/artifacts/APPROVALS_QUEUE';
            execSync(`mkdir -p ${briefDir} ${approvalsDir}`);

            // Write artifacts
            fs.writeFileSync(briefPath, briefContent);
            fs.writeFileSync(approvalsPath, approvalsContent);

            // Show changes
            try {
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');

              // Check for changes
              execSync('git add COCKPIT/artifacts/DAILY_BRIEF/ COCKPIT/artifacts/APPROVALS_QUEUE/');
              const status = execSync('git status --porcelain', { encoding: 'utf-8' });

              if (status.trim()) {
                console.log('Changes detected:');
                console.log(status);

                // Commit changes
                execSync('git commit -m "chore: update daily brief and approvals queue"');

                // Push to remote
                execSync(`git push -f origin ${branchName}`);
                console.log(`Pushed branch: ${branchName}`);
              } else {
                console.log('No changes to commit');
                return;
              }
            } catch (e) {
              console.error('Error committing changes:', e.message);
            }

            // Create or update pull request
            const prTitle = `chore: daily brief + approvals queue (${dateStr})`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const mainBranch = 'main';

            // Check if PR already exists
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branchName}`,
              base: mainBranch,
              state: 'open'
            });

            // Extract decision count from approvals content
            const decisionMatch = approvalsContent.match(/Total Decisions Required: (\d+)/);
            const decisionCount = decisionMatch ? parseInt(decisionMatch[1]) : 0;

            const hasTraeNeeded = approvalsContent.includes('TRAE REVIEW REQUIRED');
            const hasWaitingApproval = approvalsContent.includes('Founder Decisions Needed');

            // Build PR description with links to artifacts
            let prBody = `## Daily Brief + Approvals Queue ‚Äî ${dateStr}\n\n`;
            prBody += `**Generated**: ${new Date().toISOString()}\n\n`;
            prBody += `### Artifact Links\n\n`;
            prBody += `- **Daily Brief**: \`${briefPath}\`\n`;
            prBody += `- **Approvals Queue**: \`${approvalsPath}\`\n\n`;
            prBody += `### Summary\n\n`;
            prBody += `- **Decisions Required**: ${decisionCount}\n`;
            prBody += `- **Trae Review Needed**: ${hasTraeNeeded ? '‚úÖ Yes' : '‚ùå No'}\n`;
            prBody += `- **Waiting for Approval**: ${hasWaitingApproval ? '‚úÖ Yes' : '‚ùå No'}\n\n`;
            prBody += `### Review Instructions\n\n`;
            if (decisionCount === 0) {
              prBody += `‚úÖ **No founder actions required** - System operating autonomously.\n\n`;
            } else {
              prBody += `1. Review the [Daily Brief](${briefPath}) for overview\n`;
              prBody += `2. Review the [Approvals Queue](${approvalsPath}) for decision items\n`;
              prBody += `3. Respond to each decision item by commenting on this PR\n`;
              prBody += `4. Factory agents will automatically process your decisions\n\n`;
            }
            prBody += `---\n\n`;
            prBody += `*This PR is auto-generated by the daily-brief workflow. Machine Board governs this artifact update.*`;

            if (pulls.length > 0) {
              // Update existing PR
              const existingPr = pulls[0];
              console.log(`Updating existing PR #${existingPr.number}`);

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: existingPr.number,
                title: prTitle,
                body: prBody,
              });

              console.log(`Updated PR #${existingPr.number}`);
            } else {
              // Create new PR
              console.log(`Creating new PR`);

              const { data: newPr } = await github.rest.pulls.create({
                owner,
                repo,
                title: prTitle,
                head: `${owner}:${branchName}`,
                base: mainBranch,
                body: prBody,
              });

              console.log(`Created PR #${newPr.number}: ${newPr.html_url}`);
            }

      - name: Report Summary
        if: always()
        run: |
          echo "## Daily Brief Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Brief path: \`${{ steps.generate.outputs.brief_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Approvals path: \`${{ steps.generate.outputs.approvals_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: ${{ github.event.inputs.dry_run || false }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts available in workflow run artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Failure notification
        if: failure()
        run: |
          echo "‚ùå Daily brief generation failed"
          echo "Check workflow logs for errors"
          exit 1
