name: machine-board

# Pull Request Governance Enforcement - Machine Board of Directors
# This workflow enforces automated governance on all pull requests.
# PRs must pass all validation checks before merge is allowed.
#
# Validation Checks:
# 1. STATE file updates for non-BACKLOG PRs
# 2. Protected path artifacts (PLAN, VERIFICATION sections)
# 3. Risk tier requirements (rollback for T1/T2)
# 4. Secret detection
# 5. Autonomous review artifact presence for T1-T4 PRs
# 6. No-doc-spam enforcement (single collaboration surface)
#
# Reference: GOVERNANCE/GUARDRAILS.md

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]
  push:
    branches: [main]

jobs:
  machine-board:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Get Changed Files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100
            });

            const files = pr.data.map(f => f.filename).join('\n');
            console.log(`Changed files (${pr.data.length}):`);
            pr.data.forEach(f => console.log(`  - ${f.filename}`));
            core.setOutput('files', files);
            core.setOutput('count', pr.data.length);

      - name: Get PR Description
        id: pr-info
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const body = pr.data.body || '';
            core.setOutput('body', body);
            core.setOutput('title', pr.data.title);
            return body;

      - name: Run Governance Validator
        id: validate
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
          PR_DESCRIPTION: ${{ steps.pr-info.outputs.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python scripts/governance_validator.py

      - name: Comment on Success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            // Check if we already have a success comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Machine Board of Directors')
            );

            const successMsg = `### ‚úÖ Machine Board of Directors - Validation Passed

All governance checks have passed. This PR is ready for review.

**Checks Completed:**
- STATE file updates
- Protected path artifacts
- Risk tier requirements
- Secret detection
- Doc-spam prevention

---
*Automated governance check by Machine Board*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: successMsg
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: successMsg
              });
            }

      - name: Comment on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            // Check if we already have a failure comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Machine Board of Directors')
            );

            const failMsg = `### ‚ùå Machine Board of Directors - Validation Failed

Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

**Common Fixes:**

1. **STATE Updates Required**
   - Update \`STATE/STATUS_LEDGER.md\` with current changes
   - Update \`STATE/LAST_KNOWN_STATE.md\` if needed

2. **Protected Path Artifacts**
   - Add \`## PLAN\` section to PR description
   - Add \`## VERIFICATION\` section to PR description

3. **T1/T2 Risk Tier**
   - Include rollback plan in PR description
   - Include verification proof

4. **Autonomous Review**
   - Create verification artifact in \`COCKPIT/artifacts/VERIFICATION/\`
   - Ensure artifact contains \`verdict: PASS\`

5. **No Doc Spam**
   - Use \`COCKPIT/WORKSPACE/TEAM_LOG.md\` for coordination
   - Only create artifacts in \`COCKPIT/artifacts/\`

---
*Automated governance check by Machine Board*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: failMsg
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failMsg
              });
            }

  # Push validation (informational only, doesn't block)
  push-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Audit Push
        run: |
          echo "ü§ñ Machine Board of Directors - Push Audit"
          echo "================================================"
          echo "Push to main detected."
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Note: Direct pushes should be avoided."
          echo "All changes should go through PR workflow."
          echo "================================================"
