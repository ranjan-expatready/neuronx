name: machine-board

# Pull Request Governance Enforcement - Machine Board of Directors
# This workflow enforces automated governance on all pull requests.
# PRs must pass all validation checks before merge is allowed.

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]
  push:
    branches: [main]

jobs:
  machine-board:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get Changed Files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const files = pr.data.map(f => f.filename).join('\n');
            console.log('Changed files:', pr.data.length, 'files');
            return files;

      - name: Run Governance Validator
        id: machine-board
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_DESCRIPTION: ${{ github.event.pull_request.body || github.event.head_commit.message }}
          GITHUB_BASE_REF: ${{ github.event.base_ref || github.event.pull_request.base.ref || 'main' }}
          EVENT_NAME: ${{ github.event_name }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.result }}
        run: |
          echo "ü§ñ Running Machine Board of Directors Governance Validator"
          echo "Event: $EVENT_NAME"
          echo "PR Number: $PR_NUMBER"
          echo "Base Branch: $GITHUB_BASE_REF"
          echo "Changed Files: $CHANGED_FILES"
          echo ""

          # Skip validation on push events (only for PRs)
          if [ "$EVENT_NAME" != "pull_request" ] && [ "$EVENT_NAME" != "pull_request_target" ]; then
            echo "‚ÑπÔ∏è  Skipping governance validator on push events"
            echo "‚úÖ Governance validation passed (skipped)"
            exit 0
          fi

          # Export CHANGED_FILES for Python script
          export CHANGED_FILES="$CHANGED_FILES"

          python scripts/governance_validator.py

      - name: Upload validation results
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: governance-validator-results
          path: .governance_validator_results.json
          retention-days: 30

      - name: Comment results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const resultsPath = '.governance_validator_results.json';

            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

              let comment = '## ü§ñ Machine Board of Directors - Validation Results\n\n';

              const passed = results.results.every(r => r.passed);
              const status = passed ? '‚úÖ PASSED' : '‚ùå FAILED';

              comment += `**Overall Status: ${status}**\n\n`;
              comment += '### Validation Checks\n\n';

              results.results.forEach(r => {
                const icon = r.passed ? '‚úÖ' : '‚ùå';
                comment += `${icon} **${r.name}**\n`;
                if (r.message) {
                  comment += `   ${r.message}\n`;
                }
                comment += '\n';
              });

              // Add guidance for failures
              if (!passed) {
                comment += '### Required Actions\n\n';
                comment += 'To fix validation failures:\n\n';
                comment += '1. **Missing Artifacts**: Add PLAN and VERIFICATION sections to PR description\n';
                comment += '2. **STATE Files**: Update STATE/STATUS_LEDGER.md and STATE/LAST_KNOWN_STATE.md\n';
                comment += '3. **Risk Tier**: For T1/T2, include rollback plan and verification proof\n';
                comment += '4. **Secrets**: Remove or rotate any exposed credentials\n\n';
                comment += 'See GOVERNANCE/GUARDRAILS.md for detailed requirements.\n';
              }

              // Post comment
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail if validation failed
        if: steps.machine-board.outcome == 'failure'
        run: |
          echo "‚ùå Governance validation failed"
          echo "Please fix the validation errors and push a new commit."
          exit 1

      - name: Mark as passed
        if: steps.machine-board.outcome == 'success'
        run: echo "‚úÖ Governance validation passed"
